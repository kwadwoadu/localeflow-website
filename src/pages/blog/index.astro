---
import BlogLayout from '../../layouts/BlogLayout.astro';
import BlogCard from '../../components/blog/BlogCard.astro';
import BlogCategoryNav from '../../components/blog/BlogCategoryNav.astro';
import { getAllPosts, getFeaturedPosts, getPostsByCategory, paginatePosts, BLOG_CATEGORIES, type BlogCategory } from '../../lib/blog';
import { generateBlogIndexSchema } from '../../lib/seo';

// Get category from URL params
const url = new URL(Astro.request.url);
const categoryParam = url.searchParams.get('category') as BlogCategory | null;
const pageParam = parseInt(url.searchParams.get('page') || '1', 10);

// Fetch posts
const allPosts = categoryParam ? await getPostsByCategory(categoryParam) : await getAllPosts();
const featuredPosts = await getFeaturedPosts(1);
const { posts, totalPages, currentPage, hasNextPage, hasPrevPage } = paginatePosts(allPosts, pageParam, 12);

// Show featured post only on first page without category filter
const showFeatured = !categoryParam && currentPage === 1 && featuredPosts.length > 0;
const displayPosts = showFeatured ? posts.filter(p => p.id !== featuredPosts[0].id) : posts;

const title = categoryParam ? `${BLOG_CATEGORIES[categoryParam].label} - Blog` : 'Blog';
const description = categoryParam
  ? BLOG_CATEGORIES[categoryParam].description
  : 'Guides, tutorials, and best practices for Shopify store translation and localization.';
---

<BlogLayout title={title} description={description}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(generateBlogIndexSchema())} />
  </Fragment>

  <!-- Hero Section -->
  <section class="py-16 md:py-20 bg-gradient-to-b from-primary-50 to-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center max-w-3xl mx-auto">
        <h1 class="font-display font-bold text-4xl md:text-5xl text-gray-900">
          {categoryParam ? BLOG_CATEGORIES[categoryParam].label : 'LocaleFlow Blog'}
        </h1>
        <p class="mt-4 text-lg text-gray-600">
          {description}
        </p>
      </div>

      <!-- Category Navigation -->
      <div class="mt-10 flex justify-center">
        <BlogCategoryNav activeCategory={categoryParam || 'all'} />
      </div>
    </div>
  </section>

  <!-- Featured Post -->
  {showFeatured && (
    <section class="py-12 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center gap-2 mb-6">
          <svg class="w-5 h-5 text-primary-600" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
          </svg>
          <span class="text-sm font-medium text-gray-600">Featured</span>
        </div>
        <BlogCard post={featuredPosts[0]} featured />
      </div>
    </section>
  )}

  <!-- Posts Grid -->
  <section class="py-12 md:py-16 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      {displayPosts.length > 0 ? (
        <>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {displayPosts.map((post) => (
              <BlogCard post={post} />
            ))}
          </div>

          <!-- Pagination -->
          {totalPages > 1 && (
            <nav class="mt-12 flex justify-center gap-2">
              {hasPrevPage && (
                <a
                  href={`/blog?${categoryParam ? `category=${categoryParam}&` : ''}page=${currentPage - 1}`}
                  class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors"
                >
                  Previous
                </a>
              )}

              {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => (
                <a
                  href={`/blog?${categoryParam ? `category=${categoryParam}&` : ''}page=${page}`}
                  class={`px-4 py-2 rounded-lg transition-colors ${
                    page === currentPage
                      ? 'bg-primary-600 text-white'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  {page}
                </a>
              ))}

              {hasNextPage && (
                <a
                  href={`/blog?${categoryParam ? `category=${categoryParam}&` : ''}page=${currentPage + 1}`}
                  class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors"
                >
                  Next
                </a>
              )}
            </nav>
          )}
        </>
      ) : (
        <div class="text-center py-16">
          <svg class="w-16 h-16 mx-auto text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
          </svg>
          <h3 class="mt-4 font-display font-semibold text-xl text-gray-900">No posts yet</h3>
          <p class="mt-2 text-gray-600">Check back soon for new content!</p>
          {categoryParam && (
            <a href="/blog" class="mt-4 inline-flex items-center text-primary-600 hover:text-primary-700 font-medium">
              View all posts
              <svg class="ml-1 w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          )}
        </div>
      )}
    </div>
  </section>

  <!-- CTA Section -->
  <section class="py-16 bg-gradient-to-r from-primary-600 to-primary-700">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="font-display font-bold text-3xl text-white">
        Ready to translate your Shopify store?
      </h2>
      <p class="mt-4 text-primary-100 text-lg">
        Start with a free trial. No credit card required.
      </p>
      <a
        href="https://apps.shopify.com/locale-flow"
        target="_blank"
        rel="noopener"
        class="mt-6 inline-flex items-center px-6 py-3 bg-white text-primary-700 font-semibold rounded-xl hover:bg-primary-50 transition-colors shadow-lg"
      >
        Start Translating Free
        <svg class="ml-2 w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
        </svg>
      </a>
    </div>
  </section>
</BlogLayout>
